name: Build Book

on:
  push:
    # Run on any branch
    paths:
      - 'book/**'
      - 'art/**'
      - 'templates/**'
      - 'build.sh'
      - 'tools/**'
      - '.github/workflows/build-book.yml'
  workflow_dispatch:

# Add permissions block to fix 403 error when creating releases
permissions:
  contents: write
  deployments: write

jobs:
  setup:
    runs-on: ubuntu-latest
    container:
      image: iksnae/book-builder:latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      date: ${{ steps.version.outputs.date }}
      cover_found: ${{ steps.cover.outputs.cover_found }}
    steps:
      - uses: actions/checkout@v4

      - name: Set version and date
        id: version
        run: |
          VERSION=$(date +'v%Y.%m.%d-%H%M')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          DATE=$(date +'%B %d, %Y')
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Create build directories
        run: mkdir -p build

      - name: Create templates directory
        run: mkdir -p templates

      - name: Check for cover image
        id: cover
        run: |
          if [ -f "art/cover.png" ]; then
            echo "COVER_IMAGE=art/cover.png" >> $GITHUB_ENV
            echo "‚úÖ Found cover image at art/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
          elif [ -f "book/images/cover.png" ]; then
            echo "COVER_IMAGE=book/images/cover.png" >> $GITHUB_ENV
            echo "‚úÖ Found cover image at book/images/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
          elif [ -f "book/en/images/cover.png" ]; then
            echo "COVER_IMAGE=book/en/images/cover.png" >> $GITHUB_ENV
            echo "‚úÖ Found cover image at book/en/images/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No cover image found"
            echo "cover_found=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: ubuntu-latest
    container:
      image: iksnae/book-builder:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Prepare environment
        run: |
          mkdir -p build
          mkdir -p templates
          mkdir -p build/es
          mkdir -p build/images
          mkdir -p build/es/images

      - name: Build book
        run: |
          echo "Running enhanced build script..."
          chmod +x build.sh
          # Run the build script with the all-languages flag
          ./build.sh --all-languages || echo "Build script completed with warnings"

      - name: List build directory contents
        run: |
          echo "=== Build Directory Contents ==="
          ls -la build/
          
          echo "\n=== ES Directory Contents ==="
          ls -la build/es/ || echo "ES directory may not exist yet"
          
          echo "\n=== Images Directory Contents ==="
          ls -la build/images/ || echo "Images directory may not exist yet"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: book-files
          path: |
            build/*.pdf
            build/*.epub
            build/*.mobi
            build/*.html
            build/*.md
            build/es/*
            build/images/*

  release:
    # Only run release job on main branch
    if: github.ref == 'refs/heads/main'
    needs: [setup, build]
    runs-on: ubuntu-latest
    steps:
      # Add checkout step so Git commands work properly
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: book-files
          path: build

      - name: List build directory contents
        run: |
          echo "=== Build Directory Contents ==="
          ls -la build/
          
          echo "\n=== ES Directory Contents ==="
          ls -la build/es/ || echo "ES directory may not exist yet"

      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/actual-intelligence.pdf
            build/actual-intelligence.epub
            build/actual-intelligence.mobi
            build/actual-intelligence.html
            build/inteligencia-real.pdf
            build/inteligencia-real.epub
            build/inteligencia-real.mobi
          tag_name: ${{ needs.setup.outputs.version }}
          name: Actual Intelligence ${{ needs.setup.outputs.version }}
          body: |
            # Actual Intelligence Book
            
            Built on ${{ needs.setup.outputs.date }} by Khaos Studios
            
            ## üìö Download Options
            
            ### English Version
            
            | Format | Description | Link |
            |--------|-------------|------|
            | üìÑ PDF | For reading on computers and printing | [Download PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/actual-intelligence.pdf) |
            | üì± EPUB | For most e-readers and mobile devices | [Download EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/actual-intelligence.epub) |
            | üìö MOBI | For Kindle devices | [Download MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/actual-intelligence.mobi) |
            | üåê HTML | Read online in your browser | [View HTML](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/actual-intelligence.html) |
            
            ### Spanish Version (Versi√≥n en Espa√±ol)
            
            | Format | Description | Link |
            |--------|-------------|------|
            | üìÑ PDF | Para leer en computadoras e imprimir | [Descargar PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/inteligencia-real.pdf) |
            | üì± EPUB | Para la mayor√≠a de los lectores electr√≥nicos y dispositivos m√≥viles | [Descargar EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/inteligencia-real.epub) |
            | üìö MOBI | Para dispositivos Kindle | [Descargar MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/inteligencia-real.mobi) |
            
            ## üîÑ Web Version
            
            The latest version is also available online:
            - English: https://iksnae.github.io/actual-intelligence/
            - Spanish: https://iksnae.github.io/actual-intelligence/es/
          draft: false

  deploy:
    # Only run deploy job on main branch
    if: github.ref == 'refs/heads/main'
    needs: [build, release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: book-files
          path: build

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build
          branch: gh-pages