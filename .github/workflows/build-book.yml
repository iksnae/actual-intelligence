name: Build Book

on:
  push:
    branches: [main]
    paths:
      - 'book/**'
      - 'art/**'
      - 'templates/**'
      - 'build.sh'
      - 'tools/**'
      - '.github/workflows/build-book.yml'
  workflow_dispatch:

# Add permissions block to fix 403 error when creating releases
permissions:
  contents: write
  deployments: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: iksnae/book-builder:latest

    steps:
      - uses: actions/checkout@v4

      - name: Set version and date
        id: version
        run: |
          VERSION=$(date +'v%Y.%m.%d-%H%M')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "DATE=$(date +'%B %d, %Y')" >> $GITHUB_ENV

      - name: Create build directories
        run: mkdir -p build

      - name: Create templates directory
        run: mkdir -p templates

      - name: Check for cover image
        id: cover
        run: |
          if [ -f "art/cover.png" ]; then
            echo "COVER_IMAGE=art/cover.png" >> $GITHUB_ENV
            echo "âœ… Found cover image at art/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
          elif [ -f "book/images/cover.png" ]; then
            echo "COVER_IMAGE=book/images/cover.png" >> $GITHUB_ENV
            echo "âœ… Found cover image at book/images/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
          elif [ -f "book/en/images/cover.png" ]; then
            echo "COVER_IMAGE=book/en/images/cover.png" >> $GITHUB_ENV
            echo "âœ… Found cover image at book/en/images/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No cover image found"
            echo "cover_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Build book
        run: |
          echo "Running enhanced build script..."
          chmod +x build.sh
          ./build.sh || echo "Build script completed with warnings"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: book-files
          path: |
            build/*.pdf
            build/*.epub
            build/*.mobi
            build/*.html
            build/*.md
            build/es/*
            build/images/*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: book-files
          path: build

      - name: Get current date
        id: date
        run: echo "DATE=$(date +'%B %d, %Y')" >> $GITHUB_ENV

      - name: Set version
        id: version
        run: echo "VERSION=$(date +'v%Y.%m.%d-%H%M')" >> $GITHUB_ENV

      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/actual-intelligence.pdf
            build/actual-intelligence.epub
            build/actual-intelligence.mobi
            build/actual-intelligence.html
            build/inteligencia-real.pdf
            build/inteligencia-real.epub
            build/inteligencia-real.mobi
          tag_name: ${{ env.VERSION }}
          name: Actual Intelligence ${{ env.VERSION }}
          body: |
            # Actual Intelligence Book
            
            Built on ${{ env.DATE }} by Khaos Studios
            
            ## ğŸ“š Download Options
            
            ### English Version
            
            | Format | Description | Link |
            |--------|-------------|------|
            | ğŸ“„ PDF | For reading on computers and printing | [Download PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ env.VERSION }}/actual-intelligence.pdf) |
            | ğŸ“± EPUB | For most e-readers and mobile devices | [Download EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ env.VERSION }}/actual-intelligence.epub) |
            | ğŸ“š MOBI | For Kindle devices | [Download MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ env.VERSION }}/actual-intelligence.mobi) |
            | ğŸŒ HTML | Read online in your browser | [View HTML](https://github.com/iksnae/actual-intelligence/releases/download/${{ env.VERSION }}/actual-intelligence.html) |
            
            ### Spanish Version (VersiÃ³n en EspaÃ±ol)
            
            | Format | Description | Link |
            |--------|-------------|------|
            | ğŸ“„ PDF | Para leer en computadoras e imprimir | [Descargar PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ env.VERSION }}/inteligencia-real.pdf) |
            | ğŸ“± EPUB | Para la mayorÃ­a de los lectores electrÃ³nicos y dispositivos mÃ³viles | [Descargar EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ env.VERSION }}/inteligencia-real.epub) |
            | ğŸ“š MOBI | Para dispositivos Kindle | [Descargar MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ env.VERSION }}/inteligencia-real.mobi) |
            
            ## ğŸ”„ Web Version
            
            The latest version is also available online:
            - English: https://iksnae.github.io/actual-intelligence/
            - Spanish: https://iksnae.github.io/actual-intelligence/es/
          draft: false

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build
          branch: gh-pages