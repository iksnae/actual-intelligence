name: Build Book

on:
  push:
    # Run on any branch
    paths:
      - 'book/**'
      - 'art/**'
      - 'templates/**'
      - 'build.sh'
      - 'tools/**'
      - '.github/workflows/build-book.yml'
  workflow_dispatch:

# Add permissions block to fix 403 error when creating releases
permissions:
  contents: write
  deployments: write

jobs:
  setup:
    runs-on: ubuntu-latest
    container:
      image: iksnae/book-builder:latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      date: ${{ steps.version.outputs.date }}
      cover_found: ${{ steps.cover.outputs.cover_found }}
    steps:
      - uses: actions/checkout@v4

      - name: Set version and date
        id: version
        run: |
          VERSION=$(date +'v%Y.%m.%d-%H%M')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          DATE=$(date +'%B %d, %Y')
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: Create build directories
        run: |
          mkdir -p build
          mkdir -p build/es
          mkdir -p build/images
          mkdir -p build/es/images

      - name: Create templates directory
        run: mkdir -p templates

      - name: Check for cover image
        id: cover
        run: |
          if [ -f "art/cover.png" ]; then
            echo "COVER_IMAGE=art/cover.png" >> $GITHUB_ENV
            echo "âœ… Found cover image at art/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
            
            # Copy to both language-specific image directories
            mkdir -p book/images
            mkdir -p book/en/images
            mkdir -p book/es/images
            cp art/cover.png book/images/cover.png
            cp art/cover.png book/en/images/cover.png
            cp art/cover.png book/es/images/cover.png
            
          elif [ -f "book/images/cover.png" ]; then
            echo "COVER_IMAGE=book/images/cover.png" >> $GITHUB_ENV
            echo "âœ… Found cover image at book/images/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
            
            # Copy to language-specific image directories
            mkdir -p book/en/images
            mkdir -p book/es/images
            cp book/images/cover.png book/en/images/cover.png
            cp book/images/cover.png book/es/images/cover.png
            
          elif [ -f "book/en/images/cover.png" ]; then
            echo "COVER_IMAGE=book/en/images/cover.png" >> $GITHUB_ENV
            echo "âœ… Found cover image at book/en/images/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
            
            # Copy to common and Spanish image directories
            mkdir -p book/images
            mkdir -p book/es/images
            cp book/en/images/cover.png book/images/cover.png
            cp book/en/images/cover.png book/es/images/cover.png
            
          elif [ -f "book/es/images/cover.png" ]; then
            echo "COVER_IMAGE=book/es/images/cover.png" >> $GITHUB_ENV
            echo "âœ… Found cover image at book/es/images/cover.png"
            echo "cover_found=true" >> $GITHUB_OUTPUT
            
            # Copy to common and English image directories
            mkdir -p book/images
            mkdir -p book/en/images
            cp book/es/images/cover.png book/images/cover.png
            cp book/es/images/cover.png book/en/images/cover.png
            
          else
            echo "âš ï¸ No cover image found"
            echo "cover_found=false" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: ubuntu-latest
    container:
      image: iksnae/book-builder:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Prepare environment
        run: |
          mkdir -p build
          mkdir -p templates
          mkdir -p build/images
          mkdir -p build/es
          mkdir -p build/es/images
          
          # Fix permissions on script files
          chmod +x build.sh
          find tools/scripts -name "*.sh" -exec chmod +x {} \;

      - name: Build book (All languages)
        run: |
          echo "Running build script for all languages..."
          # Run the build script with all languages
          ./build.sh --all-languages || echo "Build script completed with warnings"

      - name: List build directory contents
        run: |
          echo "=== Build Directory Contents ==="
          ls -la build/
          
          echo "\n=== ES Directory Contents ==="
          ls -la build/es/ || echo "ES directory may not exist yet"
          
          echo "\n=== Images Directory Contents ==="
          ls -la build/images/ || echo "Images directory may not exist yet"
          
          echo "\n=== ES Images Directory Contents ==="
          ls -la build/es/images/ || echo "ES images directory may not exist yet"

      - name: Verify multilingual outputs
        run: |
          echo "=== Verifying English Files ==="
          if [ -f "build/actual-intelligence.pdf" ]; then
            echo "âœ… English PDF exists"
            du -h build/actual-intelligence.pdf
          else
            echo "âŒ English PDF missing"
          fi
          
          if [ -f "build/actual-intelligence.epub" ]; then
            echo "âœ… English EPUB exists"
            du -h build/actual-intelligence.epub
          else
            echo "âŒ English EPUB missing"
          fi
          
          if [ -f "build/actual-intelligence.mobi" ]; then
            echo "âœ… English MOBI exists"
            du -h build/actual-intelligence.mobi
          else
            echo "âŒ English MOBI missing"
          fi
          
          echo "=== Verifying Spanish Files ==="
          if [ -f "build/inteligencia-real.pdf" ]; then
            echo "âœ… Spanish PDF exists"
            du -h build/inteligencia-real.pdf
          else
            echo "âŒ Spanish PDF missing"
          fi
          
          if [ -f "build/inteligencia-real.epub" ]; then
            echo "âœ… Spanish EPUB exists"
            du -h build/inteligencia-real.epub
          else
            echo "âŒ Spanish EPUB missing"
          fi
          
          if [ -f "build/inteligencia-real.mobi" ]; then
            echo "âœ… Spanish MOBI exists"
            du -h build/inteligencia-real.mobi
          else
            echo "âŒ Spanish MOBI missing"
          fi
          
          # Check if any Spanish files are missing and need to be manually copied
          echo "=== Checking Spanish ES Directory ==="
          if [ -f "build/es/inteligencia-real.pdf" ] && [ ! -f "build/inteligencia-real.pdf" ]; then
            echo "âš ï¸ Spanish PDF found in build/es/ but not in root, copying..."
            cp build/es/inteligencia-real.pdf build/
          fi
          
          if [ -f "build/es/inteligencia-real.epub" ] && [ ! -f "build/inteligencia-real.epub" ]; then
            echo "âš ï¸ Spanish EPUB found in build/es/ but not in root, copying..."
            cp build/es/inteligencia-real.epub build/
          fi
          
          if [ -f "build/es/inteligencia-real.mobi" ] && [ ! -f "build/inteligencia-real.mobi" ]; then
            echo "âš ï¸ Spanish MOBI found in build/es/ but not in root, copying..."
            cp build/es/inteligencia-real.mobi build/
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: book-files
          path: |
            build/*.pdf
            build/*.epub
            build/*.mobi
            build/*.html
            build/*.md
            build/es/*
            build/images/*

  release:
    # Only run release job on main branch
    if: github.ref == 'refs/heads/main'
    needs: [setup, build]
    runs-on: ubuntu-latest
    steps:
      # Add checkout step so Git commands work properly
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: book-files
          path: build

      - name: List build directory contents
        run: |
          echo "=== Build Directory Contents ==="
          ls -la build/
          
          echo "\n=== ES Directory Contents ==="
          ls -la build/es/ || echo "ES directory may not exist yet"
          
          echo "\n=== File Sizes ==="
          du -h build/*.pdf build/*.epub build/*.mobi 2>/dev/null || echo "Some files may be missing"

      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/actual-intelligence.pdf
            build/actual-intelligence.epub
            build/actual-intelligence.mobi
            build/actual-intelligence.html
            build/inteligencia-real.pdf
            build/inteligencia-real.epub
            build/inteligencia-real.mobi
          tag_name: ${{ needs.setup.outputs.version }}
          name: Actual Intelligence ${{ needs.setup.outputs.version }}
          body: |
            # Actual Intelligence Book
            
            Built on ${{ needs.setup.outputs.date }} by Khaos Studios
            
            ## ğŸ“š Download Options
            
            ### English Version
            
            | Format | Description | Link |
            |--------|-------------|------|
            | ğŸ“„ PDF | For reading on computers and printing | [Download PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/actual-intelligence.pdf) |
            | ğŸ“± EPUB | For most e-readers and mobile devices | [Download EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/actual-intelligence.epub) |
            | ğŸ“š MOBI | For Kindle devices | [Download MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/actual-intelligence.mobi) |
            | ğŸŒ HTML | Read online in your browser | [View HTML](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/actual-intelligence.html) |
            
            ### Spanish Version (VersiÃ³n en EspaÃ±ol)
            
            | Format | Description | Link |
            |--------|-------------|------|
            | ğŸ“„ PDF | Para leer en computadoras e imprimir | [Descargar PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/inteligencia-real.pdf) |
            | ğŸ“± EPUB | Para la mayorÃ­a de los lectores electrÃ³nicos y dispositivos mÃ³viles | [Descargar EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/inteligencia-real.epub) |
            | ğŸ“š MOBI | Para dispositivos Kindle | [Descargar MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.setup.outputs.version }}/inteligencia-real.mobi) |
            
            ## ğŸ”„ Web Version
            
            The latest version is also available online:
            - English: https://iksnae.github.io/actual-intelligence/
            - Spanish: https://iksnae.github.io/actual-intelligence/es/
          draft: false

  deploy:
    # Only run deploy job on main branch
    if: github.ref == 'refs/heads/main'
    needs: [build, release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: book-files
          path: build

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: build
          branch: gh-pages