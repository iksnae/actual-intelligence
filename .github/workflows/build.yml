name: Build Book

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: iksnae/book-builder:latest

    steps:
    - uses: actions/checkout@v4

    # Setup book-tools CLI properly
    - name: Set up environment
      run: |
        echo "Setting up book-tools CLI..."
        
        # Run our custom installation script
        bash .github/custom-install.sh
        
        # Add to PATH
        export PATH="$HOME/.local/bin:$PATH"
        
        # Verify installation
        book-tools --version || echo "Version command not available, but installation should be complete"
        which book-tools
        
        # Debug directory structure
        echo "=== Directory Structure ==="
        ls -la
        echo "=== Book Directory ==="
        ls -la book/
        echo "=== English Directory ==="
        ls -la book/en/
        echo "=== Chapter 1 Directory ==="
        ls -la book/en/chapter-01/

    # Build the book using the CLI
    - name: Build book
      run: |
        # Set verbose mode for detailed logging
        export VERBOSE=true
        
        # Add to PATH (again, for this step)
        export PATH="$HOME/.local/bin:$PATH"
        
        # Build for all languages using the CLI
        book-tools build --all-languages --verbose

    # Upload build artifacts
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: book-builds
        path: build/