name: Build Book

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: iksnae/book-builder:latest

    steps:
    - uses: actions/checkout@v4

    # Create required directories
    - name: Set up environment
      run: |
        mkdir -p ~/.local/bin
        
        # Clone book-tools for scripts (using the updated version)
        git clone https://github.com/iksnae/book-tools.git ~/.book-tools
        
        # Make scripts executable
        chmod +x ~/.book-tools/src/scripts/*.sh
        
        # Debug directory structure
        echo "=== Directory Structure ==="
        ls -la
        echo "=== Book Directory ==="
        ls -la book/
        echo "=== English Directory ==="
        ls -la book/en/
        echo "=== Chapter 1 Directory ==="
        ls -la book/en/chapter-01/

    # Build the book for all languages
    - name: Build book
      run: |
        # Set verbose mode for detailed logging
        export VERBOSE=true
        
        # Build for all languages using the updated script
        ~/.book-tools/src/scripts/build-language.sh en
        ~/.book-tools/src/scripts/build-language.sh es

    # Upload build artifacts
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: book-builds
        path: build/