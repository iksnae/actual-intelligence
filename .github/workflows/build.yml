name: Build Book

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: iksnae/book-builder:latest

    steps:
    - uses: actions/checkout@v4

    # Setup book-tools by cloning directly 
    - name: Set up environment
      run: |
        # Clone book-tools repository directly
        git clone https://github.com/iksnae/book-tools.git ~/book-tools
        
        # Make scripts executable
        chmod +x ~/book-tools/src/scripts/*.sh
        chmod +x ~/book-tools/bin/book.js
        
        # Create a symbolic link to make the CLI available
        mkdir -p ~/.local/bin
        ln -s ~/book-tools/bin/book.js ~/.local/bin/book
        chmod +x ~/.local/bin/book
        
        # Add to PATH
        export PATH="$HOME/.local/bin:$PATH"
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
        
        # Verify installation
        which book
        
        # Debug directory structure
        echo "=== Directory Structure ==="
        ls -la
        echo "=== Book Directory ==="
        ls -la book/
        echo "=== English Directory ==="
        ls -la book/en/
        echo "=== Chapter 1 Directory ==="
        ls -la book/en/chapter-01/

    # Build the book for all languages
    - name: Build book
      run: |
        # Set verbose mode for detailed logging
        export VERBOSE=true
        
        # Add to PATH (again, for this step)
        export PATH="$HOME/.local/bin:$PATH"
        
        # Build for all languages using the CLI
        book build --all-languages --verbose

    # Upload build artifacts
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: book-builds
        path: build/