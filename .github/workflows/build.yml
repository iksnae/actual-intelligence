name: Build and Release Book

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Add permissions needed for creating tags and releases
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: iksnae/book-builder:latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # We need the full history for versioning
      
      - name: Generate version
        id: version
        run: |
          # If this is a tag, use the tag name
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            # Otherwise, use the date and time for versioning
            DATE_VERSION=$(date +'%Y.%m.%d')
            TIME_VERSION=$(date +'%H%M')
            VERSION="v${DATE_VERSION}-${TIME_VERSION}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Setup book-tools
        run: |
          echo "Setting up book-tools CLI..."
          
          # Run our custom installation script
          bash .github/custom-install.sh
          
          # Add to PATH
          export PATH="$HOME/.local/bin:$PATH"
          
          # Verify installation
          book-tools --version || echo "Version command not available, but installation should be complete"
          which book-tools
          echo "✅ book-tools CLI installed successfully"

      - name: Build book using CLI
        run: |
          echo "Building book with book-tools CLI..."
          
          # Add to PATH (again, for this step)
          export PATH="$HOME/.local/bin:$PATH"
          
          # Build book for all languages with all formats using the CLI
          book-tools build --all-languages --verbose
          
          # List the generated files
          echo "Generated files:"
          find build/ -type f \( -name "*.pdf" -o -name "*.epub" -o -name "*.mobi" -o -name "*.html" -o -name "*.docx" \) -exec ls -la {} \;

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: book-builds
          path: build/

  release:
    needs: build
    # Run the release job for both tags and pushes to main
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: book-builds
          path: build

      - name: List all files
        run: find build -type f | sort
      
      - name: Create git tag if needed
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        run: |
          # Only create a tag if we're running off main, not from an existing tag
          echo "Creating git tag ${{ needs.build.outputs.version }}"
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Create and push the tag
          git tag ${{ needs.build.outputs.version }}
          git push origin ${{ needs.build.outputs.version }}
      
      - name: Create markdown content for release
        run: |
          # Get the correct file naming pattern from the artifacts
          EN_PDF=$(find build/en -name "*.pdf" | head -n 1)
          EN_PDF_BASE=$(basename "$EN_PDF")
          EN_EPUB=$(find build/en -name "*.epub" | head -n 1)
          EN_EPUB_BASE=$(basename "$EN_EPUB")
          EN_MOBI=$(find build/en -name "*.mobi" | head -n 1)
          EN_MOBI_BASE=$(basename "$EN_MOBI")
          EN_HTML=$(find build/en -name "*.html" | head -n 1)
          EN_HTML_BASE=$(basename "$EN_HTML")
          EN_DOCX=$(find build/en -name "*.docx" | head -n 1)
          EN_DOCX_BASE=$(basename "$EN_DOCX")
          
          ES_PDF=$(find build/es -name "*.pdf" | head -n 1)
          ES_PDF_BASE=$(basename "$ES_PDF")
          ES_EPUB=$(find build/es -name "*.epub" | head -n 1)
          ES_EPUB_BASE=$(basename "$ES_EPUB")
          ES_MOBI=$(find build/es -name "*.mobi" | head -n 1)
          ES_MOBI_BASE=$(basename "$ES_MOBI")
          ES_DOCX=$(find build/es -name "*.docx" | head -n 1)
          ES_DOCX_BASE=$(basename "$ES_DOCX")
          
          cat > RELEASE.md << EOF
          # Actual Intelligence Book

          Built on $(date +"%B %d, %Y") by Khaos Studios

          ## 📚 Download Options

          ### English Version

          | Format  | Description                           | Link                                                                                                                       |
          | ------- | ------------------------------------- | -------------------------------------------------------------------------------------------------------------------------- |
          | 📄 PDF  | For reading on computers and printing | [Download PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${EN_PDF_BASE})   |
          | 📱 EPUB | For most e-readers and mobile devices | [Download EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${EN_EPUB_BASE}) |
          | 📚 MOBI | For Kindle devices                    | [Download MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${EN_MOBI_BASE}) |
          | 🌐 HTML | Read online in your browser           | [View HTML](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${EN_HTML_BASE})     |
          | 📋 DOCX | Microsoft Word format                 | [Download DOCX](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${EN_DOCX_BASE}) |

          ### Spanish Version (Versión en Español)

          | Format  | Description                                                         | Link                                                                                                                      |
          | ------- | ------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
          | 📄 PDF  | Para leer en computadoras e imprimir                                | [Descargar PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${ES_PDF_BASE})   |
          | 📱 EPUB | Para la mayoría de los lectores electrónicos y dispositivos móviles | [Descargar EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${ES_EPUB_BASE}) |
          | 📚 MOBI | Para dispositivos Kindle                                            | [Descargar MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${ES_MOBI_BASE}) |
          | 📋 DOCX | Formato Microsoft Word                                              | [Descargar DOCX](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/${ES_DOCX_BASE}) |

          ## 🔄 Web Version

          The latest version is also available online:

          * English: https://iksnae.github.io/actual-intelligence/
          * Spanish: https://iksnae.github.io/actual-intelligence/es/
          EOF

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/en/*.pdf
            build/en/*.epub
            build/en/*.mobi
            build/en/*.html
            build/en/*.docx
            build/es/*.pdf
            build/es/*.epub
            build/es/*.mobi
            build/es/*.docx
          draft: false
          prerelease: false
          name: ${{ needs.build.outputs.version }}
          tag_name: ${{ needs.build.outputs.version }}
          body_path: RELEASE.md
          token: ${{ secrets.GITHUB_TOKEN }}