name: Build and Release Book

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Add permissions needed for creating tags and releases
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: iksnae/book-builder:latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # We need the full history for versioning
      
      - name: Generate version
        id: version
        run: |
          # If this is a tag, use the tag name
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            # Otherwise, use the date and time for versioning
            DATE_VERSION=$(date +'%Y.%m.%d')
            TIME_VERSION=$(date +'%H%M')
            VERSION="v${DATE_VERSION}-${TIME_VERSION}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: Setup book-tools
        run: |
          echo "Setting up book-tools CLI..."
          
          # Run our custom installation script
          bash .github/custom-install.sh
          
          # Add to PATH
          export PATH="$HOME/.local/bin:$PATH"
          
          # Verify installation
          book-tools --version || echo "Version command not available, but installation should be complete"
          which book-tools
          echo "✅ book-tools CLI installed successfully"

      - name: Build book using CLI
        run: |
          echo "Building book with book-tools CLI..."
          
          # Add to PATH (again, for this step)
          export PATH="$HOME/.local/bin:$PATH"
          
          # Build book for all languages with all formats using the CLI
          book-tools build --all-languages --verbose
          
          # List the generated files
          echo "Generated files:"
          find build/ -type f \( -name "*.pdf" -o -name "*.epub" -o -name "*.mobi" -o -name "*.html" -o -name "*.docx" \) -exec ls -la {} \;

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: book-builds
          path: build/

  release:
    needs: build
    # Run the release job for both tags and pushes to main
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: book-builds
          path: build

      - name: List all files
        run: find build -type f | sort
      
      - name: Create git tag if needed
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        run: |
          # Only create a tag if we're running off main, not from an existing tag
          echo "Creating git tag ${{ needs.build.outputs.version }}"
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Create and push the tag
          git tag ${{ needs.build.outputs.version }}
          git push origin ${{ needs.build.outputs.version }}
      
      - name: Create markdown content for release
        run: |
          # Get the correct file naming pattern from the artifacts
          echo "Generating release notes with correct file links..."
          
          # Debug: List all files to see their exact names
          find build/ -type f | sort
          
          # Create the release markdown
          cat > RELEASE.md << EOF
          # Actual Intelligence Book

          Built on $(date +"%B %d, %Y") by Khaos Studios

          ## 📚 Download Options

          ### English Version

          | Format  | Description                           | Link                                                                                                                                        |
          | ------- | ------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
          | 📄 PDF  | For reading on computers and printing | [Download PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/en/actual-intelligence.pdf)   |
          | 📱 EPUB | For most e-readers and mobile devices | [Download EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/en/actual-intelligence.epub) |
          | 📚 MOBI | For Kindle devices                    | [Download MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/en/actual-intelligence.mobi) |
          | 🌐 HTML | Read online in your browser           | [View HTML](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/en/actual-intelligence.html)     |
          | 📋 DOCX | Microsoft Word format                 | [Download DOCX](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/en/actual-intelligence.docx) |

          ### Spanish Version (Versión en Español)

          | Format  | Description                                                         | Link                                                                                                                                        |
          | ------- | ------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
          | 📄 PDF  | Para leer en computadoras e imprimir                                | [Descargar PDF](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/es/actual-intelligence.pdf)   |
          | 📱 EPUB | Para la mayoría de los lectores electrónicos y dispositivos móviles | [Descargar EPUB](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/es/actual-intelligence.epub) |
          | 📚 MOBI | Para dispositivos Kindle                                            | [Descargar MOBI](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/es/actual-intelligence.mobi) |
          | 🌐 HTML | Leer en su navegador                                                | [Ver HTML](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/es/actual-intelligence.html)       |
          | 📋 DOCX | Formato Microsoft Word                                              | [Descargar DOCX](https://github.com/iksnae/actual-intelligence/releases/download/${{ needs.build.outputs.version }}/es/actual-intelligence.docx) |

          ## 🔄 Web Version

          The latest version is also available online:

          * English: https://iksnae.github.io/actual-intelligence/
          * Spanish: https://iksnae.github.io/actual-intelligence/es/
          EOF

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/en/actual-intelligence.pdf
            build/en/actual-intelligence.epub
            build/en/actual-intelligence.mobi
            build/en/actual-intelligence.html
            build/en/actual-intelligence.docx
            build/es/actual-intelligence.pdf
            build/es/actual-intelligence.epub
            build/es/actual-intelligence.mobi
            build/es/actual-intelligence.html
            build/es/actual-intelligence.docx
          draft: false
          prerelease: false
          name: ${{ needs.build.outputs.version }}
          tag_name: ${{ needs.build.outputs.version }}
          body_path: RELEASE.md
          token: ${{ secrets.GITHUB_TOKEN }}

  deploy-pages:
    needs: [build, release]
    # Only deploy to Pages on pushes to main or tags
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest
    # Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
    permissions:
      contents: read
      pages: write
      id-token: write
    # Allow only one concurrent deployment
    concurrency:
      group: "pages"
      cancel-in-progress: true
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: book-builds
          path: build
      
      - name: Prepare files for deployment
        run: |
          # Create directory structure for pages
          mkdir -p pages
          mkdir -p pages/es
          
          # Copy HTML files to the correct locations
          cp build/en/actual-intelligence.html pages/index.html
          cp build/es/actual-intelligence.html pages/es/index.html
          
          # Copy any image directories needed for HTML files
          cp -r build/en/images pages/ || true
          cp -r build/en/media pages/ || true
          cp -r build/es/images pages/es/ || true
          cp -r build/es/media pages/es/ || true
          
          # Create a .nojekyll file to disable Jekyll processing
          touch pages/.nojekyll
          
          # List out what we're deploying
          echo "Files to be deployed:"
          find pages -type f | sort
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'pages'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3